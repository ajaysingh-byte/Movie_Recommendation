{% extends "base.html" %}
{% block title %}Search Movies{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
<style>
  /* Center the heading and place the search bar below it with the button on the right */
  .search-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-bottom: 18px;
  }
  .search-bar {
    display: flex;
    width: 100%;
    max-width: 720px;
    gap: 8px;
  }
  .search-bar input[type="text"] {
    flex: 1 1 auto;
    padding: 10px 12px;
    font-size: 1rem;
  }
  .search-bar button {
    flex: 0 0 auto;
    padding: 10px 16px;
    font-size: 1rem;
  }
  @media (max-width: 480px) {
    .search-bar { flex-direction: column; }
    .search-bar button { width: 100%; }
  }

  .movie-card {
    background: rgba(2, 6, 23, 0.9);
    padding: 20px;
    border-radius: 18px;
    border: 1px solid rgba(148, 163, 184, 0.08);
    display: flex;
    gap: 16px;
    align-items: flex-start;
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
    transition: transform 180ms ease, box-shadow 180ms ease;
  }
  
  .movie-card .poster { flex: 0 0 120px; height: 180px; overflow: hidden; border-radius: 12px; background: rgba(255,255,255,0.03); }
  .movie-card .poster img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .movie-card .info { color: #e6eef8; }
  .movie-card .info h3 { margin: 0 0 6px 0; color: #ffffff; font-size: 1.05rem; }
  .movie-card .info .year { color: #cbd5e1; font-weight: 600; margin-left: 8px; }
  .movie-card .info .description { margin-top: 6px; color: #cbd5e1; line-height: 1.3; }
</style>
{% endblock %}

{% block content %}
<div class="search-page">
  <div class="search-header">
    <h1 style="margin:0;">Search Movies</h1>

    <!-- Search bar -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search for a movie title or genre...">
      <button id="searchBtn">Search</button>
    </div>
  </div>

  <!-- Results -->
  <div id="results" class="results-grid">
    {% if results %}
      {% for m in results %}
        <div class="movie-card">
          {% if m.poster_path %}
            <img src="https://image.tmdb.org/t/p/w154{{ m.poster_path }}" alt="{{ m.title }} poster">
          {% endif %}
          <div class="info">
            <h3>{{ m.title }}</h3>
            <p><small>{{ m.release_date }} — Rating: {{ m.vote_average }}</small></p>
            <p>{{ m.overview }}</p>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

</div>

<script>
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const resultsDiv = document.getElementById('results');

  async function searchMovies() {
    const q = searchInput.value.trim();
    resultsDiv.innerHTML = "";
    if (!q) return;

    // 1) Search in local DB movies
    let res = await fetch(`/api/movies/search?q=${encodeURIComponent(q)}`);
    let data = await res.json();

    // If nothing in DB, fallback to TMDB
    if (!data || data.length === 0) {
      res = await fetch(`/api/tmdb/search?q=${encodeURIComponent(q)}`);
      data = await res.json();
    }

    if (!data || data.length === 0) {
      resultsDiv.innerHTML = "<p>No movies found.</p>";
      return;
    }

    data.forEach(m => {
      const card = document.createElement('div');
      card.className = 'movie-card';

      // Build inner HTML using the same structure as templates/recommend_genre.html movie-card
      let inner = '';
      if (m.poster_url) {
        inner += `<img src="${m.poster_url}" alt="${(m.title || '').replace(/"/g, '&quot;')} poster">`;
      }
      inner += `<div class="info">`;
      inner += `<h3>${(m.title || '')}${m.year ? ` (${m.year})` : ''}</h3>`;
      const release = m.release_date ? m.release_date : '';
      const rating = (m.vote_average || m.rating) ? (m.vote_average || m.rating) : '';
      if (release || rating) {
        inner += `<p><small>${release}${release && rating ? ' — ' : ''}${rating}</small></p>`;
      }
      inner += `<p>${(m.overview || '').substring(0, 300)}</p>`;
      inner += `</div>`;

      card.innerHTML = inner;
      resultsDiv.appendChild(card);
    });
  }

  searchBtn.addEventListener('click', searchMovies);
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') searchMovies();
  });
</script>
{% endblock %}
